<script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js/dist/web3.min.js"></script>

<input type="date" id="myDate" value="2014-02-09">

<button onclick="dateToEpoch()">Create Ulysses Pact!</button>

<script>
  var pactInstance;
  var upAddress;
  function dateToEpoch() {
    var dateString = document.getElementById("myDate").value;
    var epoch = new Date(dateString).getTime();
    console.log(epoch);

   //TODO move
    /*
    pactInstance.createPact.call(function (err, res) {
      console.log(res + "something?");
      console.log(err + "err??something?");
    });
    */
  }

    var abi = [
      {
        "anonymous": false,
        "inputs": [
          {
            "indexed": false,
            "name": "_address",
            "type": "address"
          }
        ],
        "name": "PactCreated",
        "type": "event"
      },
      {
        "constant": false,
        "inputs": [],
        "name": "createPact",
        "outputs": [],
        "payable": false,
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "constant": false,
        "inputs": [
          {
            "name": "amount",
            "type": "uint256"
          },
          {
            "name": "length",
            "type": "uint256"
          }
        ],
        "name": "deposit",
        "outputs": [],
        "payable": true,
        "stateMutability": "payable",
        "type": "function"
      },
      {
        "constant": false,
        "inputs": [],
        "name": "withdraw",
        "outputs": [],
        "payable": false,
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "constant": true,
        "inputs": [],
        "name": "hi",
        "outputs": [
          {
            "name": "",
            "type": "string"
          }
        ],
        "payable": false,
        "stateMutability": "view",
        "type": "function"
      }
    ];

    //Web3 0.20.3
    startApp = function() {
      //unlock
      //web3.eth.defaultAccount = web3.eth.accounts[0];
      //web3.personal.unlockAccount(web3.eth.defaultAccount);

      console.log('default account is: ' + web3.eth.defaultAccount);

      var pact =  web3.eth.contract(abi);
      pactInstance = pact.at('0x54d6a091ee540995310c0fc4ca590870eb10466f');

      console.log('Is web3 connected? ' + web3.isConnected());


     //watch for a test event
     //var myEvent = pactInstance.PactCreated({},{fromBlock: 0, toBlock: 'latest'});
      var myEvent = pactInstance.PactCreated();

        myEvent.watch(function(error, result){
            console.log("on watch");
            console.log(result['args']['_address'] + "is the pact?");

            //test calling the created contract
            upAddress = result['args']['_address'];


        });

      pactInstance.hi(function (err, res) {
        console.log(res);
      });

      //TODO make this into a seperate function after its confirmed everything works
      pactInstance.createPact(function(error, result) {
        //if (!error)
          //console.log(JSON.stringify(result));
          console.log(result + " is the result of createPact");
        //else
          //console.error(error + " is the result of createPact ERROR");
      });
    };

window.addEventListener('load', async () => {
    // Modern dapp browsers...
    if (window.ethereum) {
        window.web3 = new Web3(ethereum);
        try {
            // Request account access if needed
            await ethereum.enable();
            // Acccounts now exposed
            web3.eth.sendTransaction({/* ... */});
        } catch (error) {
            // User denied account access...
        }
    }
    // Legacy dapp browsers...
    else if (window.web3) {
        window.web3 = new Web3(web3.currentProvider);
        // Acccounts always exposed
        web3.eth.sendTransaction({/* ... */});
    }
    // Non-dapp browsers...
    else {
        console.log('Non-Ethereum browser detected. You should consider trying MetaMask!');
    }

    startApp();
});
</script>
